<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.kmbeast.mapper.FlowIndexMapper">
    <select id="queryList" resultMap="BaseResultMap">
        SELECT fi.*
        FROM flow_index fi
        <where>
            1 = 1
            <if test="contentModule != null and contentModule != ''">
                AND fi.content_module=#{contentModule}
            </if>
            <if test="userId != null">
                AND fi.user_id = #{userId}
            </if>
            <if test="type != null">
                AND fi.type = #{type}
            </if>
            <if test="contentId != null">
                AND fi.content_id = #{contentId}
            </if>
            <if test="startTime != null and endTime != null">
                AND fi.create_time BETWEEN #{startTime} AND #{endTime}
            </if>
        </where>
            ORDER BY fi.id DESC
            <if test="current != null and size != null">
                LIMIT #{current},#{size}
            </if>
    </select>
    <select id="queryListCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM flow_index fi
        <where>
            1 = 1
            <if test="contentModule != null and contentModule != ''">
                AND fi.content_module=#{contentModule}
            </if>
            <if test="userId != null">
                AND fi.user_id = #{userId}
            </if>
            <if test="type != null">
                AND fi.type = #{type}
            </if>
            <if test="contentId != null">
                AND fi.content_id = #{contentId}
            </if>
            <if test="startTime != null and endTime != null">
                AND fi.create_time BETWEEN #{startTime} AND #{endTime}
            </if>
        </where>
    </select>
    <select id="queryDashboard" resultType="cn.kmbeast.pojo.vo.DashboardVO"
            parameterType="cn.kmbeast.pojo.dto.query.extend.FlowIndexQueryDto">
        select(select COUNT(*)  from flow_index WHERE content_id=#{contentId} AND content_module=#{contentModule} AND type=2)AS peopleCount,
              (select COUNT(*)  from flow_index WHERE content_id=#{contentId} AND content_module=#{contentModule}  AND type=3)AS upvoteCount,
              (select COUNT(*) from flow_index WHERE content_id=#{contentId} AND content_module=#{contentModule}  AND type=4) AS collectCount
    </select>
    <select id="recommendHealthNews" resultType="java.lang.Integer">
        select content_id from flow_index where content_module="HEALTH_NEWS" AND type="1" GROUP BY content_id order by COUNT(type) DESC LIMIT 0,3
    </select>
    <select id="listScore" resultType="cn.kmbeast.pojo.vo.FlowIndexScoreVO">
        SELECT
        user_id AS userId,
        content_id AS contentId,
        LEAST(5,
        (
        -- 基础互动评分（浏览、点赞、收藏）
        (total_views * 0.25 +
        total_upvotes * 0.35 +
        total_collects * 0.4) * 0.7 +
        -- 时长奖励分
        CASE
        WHEN total_duration &lt; 6000 THEN 0
        WHEN total_duration &lt; 20000 THEN 0.5
        WHEN total_duration &lt; 60000 THEN 1.2
        ELSE 1.8
        END
        ) *
        -- 活跃度调节因子
        (1 + LOG10(1 + (total_views + total_upvotes + total_collects) / 10))
        ) AS score
        FROM (
        SELECT
        user_id,
        content_id,
        SUM(CASE WHEN type = 2 THEN 1 ELSE 0 END) AS total_views,
        SUM(CASE WHEN type = 3 THEN 1 ELSE 0 END) AS total_upvotes,
        SUM(CASE WHEN type = 4 THEN 1 ELSE 0 END) AS total_collects,
        SUM(CASE WHEN type = 5 THEN times ELSE 0 END) AS total_duration
        FROM
        flow_index
        WHERE
        type IN (2, 3, 4, 5) -- 浏览(2)、点赞(3)、收藏(4)、停留(5)
        AND content_module = #{contentModule}
        AND content_id IN
        <foreach collection="recipeIds" open="(" close=")" separator="," item="contentId">
            #{contentId}
        </foreach>
        GROUP BY
        user_id, content_id, content_module
        HAVING
        total_views > 0 OR total_upvotes > 0 OR total_collects > 0
        ) AS aggregated_data
        ORDER BY
        score DESC;
    </select>
    <select id="recommendRecipe" resultType="java.lang.Integer">
        select content_id from flow_index where content_module="RECIPE" AND type="1" GROUP BY content_id order by COUNT(type) DESC LIMIT 0,3
    </select>
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cn.kmbeast.pojo.entity.FlowIndex">
        <id column="id" property="id"/>
        <result column="content_module" property="contentModule"/>
        <result column="content_id" property="contentId"/>
        <result column="user_id" property="userId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
</mapper>
